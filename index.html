<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vulnerability Heatmap</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link href="index.css" rel="stylesheet" />
  </head>
  <body>
    <div id="modal" class="modal modal-fixed-footer">
      <div class="modal-content">
        <div id="thecontent"></div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat"
          >Close</a
        >
      </div>
    </div>

    <nav>
      <div class="nav-wrapper">
        <img
          style="max-width: 100px; margin-left: 8px"
          src="https://www.secure-io.de/wp-content/uploads/2022/08/secureio_logo.png"
          alt="secureIO GmbH"
          id="logo"
        />

        <span style="margin-left: 12px; font-size: 20px" class="secio-black"
          >Vulnerability Heatmap ðŸ“Š</span
        >

        <ul id="nav-mobile" class="right">
          <li>
            <a class="secio-black show-help" href="#"
              ><i class="material-icons">help</i></a
            >
          </li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <form id="form" name="form">
        <div class="row">
          <div class="input-field col s12 m6">
            <input
              type="date"
              class="date-field"
              id="start_date"
              name="start_date"
            />
            <label for="start_date" class="active">Start Date </label>
          </div>
          <div class="input-field col s12 m6">
            <input
              type="date"
              class="date-field"
              id="end_date"
              name="end_date"
            />
            <label for="end_date" class="active">End Date</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <label for="scenario" class="active">Select scenario (View)
              <a href="#" class="tooltipped show-help" data-tooltip="Scenario Help">
                Show help
              </a>
            </label>
            <select style="margin-top: 10px" class="browser-default" id="scenario" name="scenario">
              <option value="avg_history" selected>
                Weighted Average (based on history)
              </option>
              <option value="sla">SLA Violations</option>
            </select>
          </div>
          <div class="input-field col s12 m6">
            <label for="scanner" class="active">Scanner</label>
            <select style="margin-top: 10px" class="browser-default" id="scanner" name="scanner">
              <option value="all" selected>All</option>
              <option value="sast">SAST/SCA</option>
              <option value="container">Container</option>
              <option value="tm">Threat Modeling</option>
              <option value="dast">DAST</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <input type="text" id="search" name="search" />
            <label for="search" class="active">Search for application names</label>
          </div>
          <div class="input-field col s12 m6">
            <input type="text" id="tag" name="tag" />
            <label for="tag" class="active">Search for application tags</label>
          </div>
        </div>
        <button
          id="submit"
          class="btn primary-color waves-effect waves-light"
          type="submit"
        >
          Load Heatmap
        </button>
      </form>
      <div id="heatmap"></div>
      <div id="lds-roller" class="lds-roller"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script type="importmap">
      {
        "imports": {
          "moment": "./node_modules/moment/dist/moment.js"
        }
      }
    </script>
    <script>
      const host = window.location.host;
      window.NODE_ENV =
        host.indexOf("github.io") > -1 || host.indexOf("localhost") > -1
          ? "test"
          : "prod";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script type="module" src="frontend/helpers.js"></script>
    <script type="module" src="frontend/main.js"></script>

    <script id="help-template" type="text/x-handlebars-template">
      <div>
        <h3>Scenarios</h3>

        <p>The heatmap dusplays vulnerabilities of applications over time. There are different scenarios possible which change the way the colors are calculated.</p>

        <div class="row">
          <div class="col s12">
            <ul class="tabs">
              <li class="tab col s3"><a class="active" href="#tab1">Weighted average</a></li>
              <li class="tab col s3"><a href="#tab2">SLA Violations</a></li>
            </ul>
          </div>
          <div id="tab1" class="col s12">
            <h5>Scenario "Weighted average" (based on history)</h5>
            <p>A weighted average is calculated based on the amount and severities
              of the cumulative findings of all scans until a certain calendar week.
              Each severity gets assigned a score. This method ensures the heatmap
              reflects both the volume and the severity of vulnerabilities. Example:</p>
            <pre>
factorCritical = 5,
factorHigh = 4,
factorMedium = 3,
factorLow = 2,
factorInfo = 1;

weighted_average = (
  sumCritical * factorCritical +
  sumHigh * factorHigh +
  sumMedium * factorMedium +
  sumLow * factorLow +
  sumInfo * factorInfo
) / sumTotalVulnerabilities

Based on this "weighted_average" value, the colors are calculated:

0 to 1 (Very Low): Green
>1 to 2 (Low): light green
>2 to 3 (Medium): Yellow
>3 to 4 (High): Red
>4 (Critical): Dark Red
            </pre>

            <p>To address the issue with the data display only per calendar week, a
              more accurate historical view of vulnerabilities for each scan type
              per calendar week, taking into account the findings from previous
              scans, a cumulative or rolling sum approach is implemented. This
              approach ensures that the current week's representation includes
              unresolved vulnerabilities from previous weeks, providing a more
              realistic view of the application's security posture over time.
            </p>
          </div>
          <div id="tab2" class="col s12">
            <h5>Scenario: "SLA Violations"</h5>
            <p>We get scans of different types per calendar week (e.g. SAST/SCA or
              Container). Each of these scans have a number of findings. These findings will be used to calculate sla violations always depending on the week looked at it.</p>

            <p>It is important to understand that we always take the historical,
              cumulative approach, i.e. in a certain CW we only check the *latest*
              scan of a scanner type. This latest scan now may have findings which
              violate the SLA and findings which do not violate it. We take only the worst critical and worst high.
            </p>

            <p>How does the sla calculation work?</p>
            <pre>
Example:
finding.date: 1.Jan (critical, i.e. time until breach=30d)
breach date: 31.Jan
-------------------
dateOfCalculation: (i.e. last day of week or today if in current week):
  2.Jan (i.e. finding is 1 day old)
sla_days_remaining: 31.Jan - 2.Jan = 29 days (NO BREACH)

or:

dateOfCalculation: 30.April (finding is 31+28+31+30 = 120 day old)
sla_days_remaining: 31.Jan - 30.April = 28+31+30 = -91 days after breach
      </pre>
          </div>
        </div>
      </div>
    </script>

    <script id="app-modal-template" type="text/x-handlebars-template">
      <div>
        <h5>{{appName}}: Calendar Week {{cwString}}</h5>

        <p>History based sum of findings:</p>
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Total</th>
              <th scope="col">Critical</th>
              <th scope="col">High</th>
              <th scope="col">Medium</th>
              <th scope="col">Low</th>
              <th scope="col">Info</th>
              <th scope="col">Sast/SCA</th>
              <th scope="col">Container</th>
              <th scope="col">Threat Modeling</th>
            </tr>
          </thead>
            <tbody>
              <tr>
                <td>{{sumTotal}}</td>
                <td>{{sumCritical}}</td>
                <td>{{sumHigh}}</td>
                <td>{{sumMedium}}</td>
                <td>{{sumLow}}</td>
                <td>{{sumInfo}}</td>
                <td>{{sumSast}}</td>
                <td>{{sumContainer}}</td>
                <td>{{sumTM}}</td>
              </tr>
            </tbody>
        </table>

        <p>All scans uploaded in this week:</p>
        <div id="chart-scans-of-week"></div>
        {{#if scansOfCurrentWeek.length}}
        <ul>
        {{#each scansOfCurrentWeek}}
        <li> Scan from {{this.dateStr}} of type <b>{{this.scannerName}}</b> has {{this.numberTotalVulnerabilities}} findings
        </li>
        {{/each}}
        </ul>
        {{else}}
        <p style="color:red">No scan at all happened in this week!</p>
        {{/if}}

        <!-- TODO:
         <p>All scans of this application:</p>
        <div id="chart-all-scans"></div> -->
      </div>
    </script>
  </body>
</html>
