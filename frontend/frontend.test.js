import assert from "assert";
import moment from "moment";
import {
  isInCalendarWeek,
  getScansOfCalendarWeek,
  normalizeScansForHistoricalView,
} from "./helpers.js";

let SCANS = [
  {
    buildId: null,
    id: 21336,
    importTime: 1670042790000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 3,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 7,
    numberRepeatFindings: 7,
    numberRepeatResults: 7,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 7,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1670042790000,
  },
  {
    buildId: null,
    id: 20980,
    importTime: 1669437895000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 3,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 7,
    numberRepeatFindings: 7,
    numberRepeatResults: 7,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 7,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1669437895000,
  },
  {
    buildId: null,
    id: 20651,
    importTime: 1668833210000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 3,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 2,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 7,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1668833210000,
  },
  {
    buildId: null,
    id: 20190,
    importTime: 1668228233000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1668228233000,
  },
  {
    buildId: null,
    id: 19708,
    importTime: 1667623816000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1667623816000,
  },
  {
    buildId: null,
    id: 19416,
    importTime: 1667024468000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1667024468000,
  },
  {
    buildId: null,
    id: 18915,
    importTime: 1666414454000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1666414454000,
  },
  {
    buildId: null,
    id: 18541,
    importTime: 1665654775000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1665654775000,
  },
  {
    buildId: null,
    id: 18301,
    importTime: 1665513251000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1665513251000,
  },
  {
    buildId: null,
    id: 18092,
    importTime: 1665206536000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1665206536000,
  },
  {
    buildId: null,
    id: 17743,
    importTime: 1664684725000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1664684725000,
  },
  {
    buildId: null,
    id: 17656,
    importTime: 1664599070000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1664599070000,
  },
  {
    buildId: null,
    id: 17230,
    importTime: 1663996491000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1663996491000,
  },
  {
    buildId: null,
    id: 16716,
    importTime: 1663389440000,
    numberClosedVulnerabilities: 1,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1663389440000,
  },
  {
    buildId: null,
    id: 14698,
    importTime: 1659759950000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 2,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 1,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 6,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1659759950000,
  },
  {
    buildId: null,
    id: 14433,
    importTime: 1659413754000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1659413754000,
  },
  {
    buildId: null,
    id: 14230,
    importTime: 1659154905000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1659154905000,
  },
  {
    buildId: null,
    id: 13866,
    importTime: 1658549705000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1658549705000,
  },
  {
    buildId: null,
    id: 13494,
    importTime: 1658007591000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1658007591000,
  },
  {
    buildId: null,
    id: 13067,
    importTime: 1657404761000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1657404761000,
  },
  {
    buildId: null,
    id: 12671,
    importTime: 1656797071000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1656797071000,
  },
  {
    buildId: null,
    id: 12242,
    importTime: 1656161270000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1656161270000,
  },
  {
    buildId: null,
    id: 11616,
    importTime: 1654936847000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1654936847000,
  },
  {
    buildId: null,
    id: 11237,
    importTime: 1654312644000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1654312644000,
  },
  {
    buildId: null,
    id: 11120,
    importTime: 1654138979000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1654138979000,
  },
  {
    buildId: null,
    id: 10839,
    importTime: 1653707402000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 5,
    numberRepeatFindings: 5,
    numberRepeatResults: 5,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1653707402000,
  },
  {
    buildId: null,
    id: 10480,
    importTime: 1653102497000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 3,
    numberNewVulnerabilities: 1,
    numberOldVulnerabilities: 4,
    numberRepeatFindings: 4,
    numberRepeatResults: 4,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 5,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1653102497000,
  },
  {
    buildId: null,
    id: 10101,
    importTime: 1652533866000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 1,
    numberMediumVulnerabilities: 2,
    numberNewVulnerabilities: 2,
    numberOldVulnerabilities: 2,
    numberRepeatFindings: 2,
    numberRepeatResults: 2,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 4,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1652533866000,
  },
  {
    buildId: null,
    id: 9687,
    importTime: 1651911129000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 2,
    numberRepeatFindings: 2,
    numberRepeatResults: 2,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 2,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1651911129000,
  },
  {
    buildId: null,
    id: 9387,
    importTime: 1651468428000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 2,
    numberRepeatFindings: 2,
    numberRepeatResults: 2,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 2,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1651468428000,
  },
  {
    buildId: null,
    id: 9232,
    importTime: 1651310907000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 2,
    numberRepeatFindings: 2,
    numberRepeatResults: 2,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 2,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1651310907000,
  },
  {
    buildId: null,
    id: 8444,
    importTime: 1650093509000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 2,
    numberRepeatFindings: 2,
    numberRepeatResults: 2,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 2,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1650093509000,
  },
  {
    buildId: null,
    id: 8053,
    importTime: 1649494363000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 1,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 1,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 2,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1649494363000,
  },
  {
    buildId: null,
    id: 6724,
    importTime: 1644843237000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1644843237000,
  },
  {
    buildId: null,
    id: 6554,
    importTime: 1644227965000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1644227965000,
  },
  {
    buildId: null,
    id: 5930,
    importTime: 1642220476000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1642220476000,
  },
  {
    buildId: null,
    id: 5681,
    importTime: 1641614858000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1641614858000,
  },
  {
    buildId: null,
    id: 5510,
    importTime: 1641204507000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1641204507000,
  },
  {
    buildId: null,
    id: 5447,
    importTime: 1641011470000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1641011470000,
  },
  {
    buildId: null,
    id: 5110,
    importTime: 1639801918000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1639801918000,
  },
  {
    buildId: null,
    id: 4883,
    importTime: 1639196803000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1639196803000,
  },
  {
    buildId: null,
    id: 4646,
    importTime: 1638415731000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1638415731000,
  },
  {
    buildId: null,
    id: 4501,
    importTime: 1637984890000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1637984890000,
  },
  {
    buildId: null,
    id: 4354,
    importTime: 1637378905000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1637378905000,
  },
  {
    buildId: null,
    id: 4234,
    importTime: 1636775653000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1636775653000,
  },
  {
    buildId: null,
    id: 4152,
    importTime: 1635823542000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1635823542000,
  },
  {
    buildId: null,
    id: 4062,
    importTime: 1635566004000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 0,
    numberOldVulnerabilities: 1,
    numberRepeatFindings: 1,
    numberRepeatResults: 1,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1635566004000,
  },
  {
    buildId: null,
    id: 3945,
    importTime: 1634961139000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 0,
    numberMediumVulnerabilities: 1,
    numberNewVulnerabilities: 1,
    numberOldVulnerabilities: 0,
    numberRepeatFindings: 0,
    numberRepeatResults: 0,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 1,
    numberUnassignedVulnerabilities: 0,
    scannerName: "KiuwanLibraries",
    updatedDate: 1634961139000,
  },
  {
    buildId: null,
    id: 3890,
    importTime: 1634655999000,
    numberClosedVulnerabilities: 883,
    numberCriticalVulnerabilities: 0,
    numberHighVulnerabilities: 0,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 98,
    numberMediumVulnerabilities: 34,
    numberNewVulnerabilities: 132,
    numberOldVulnerabilities: 0,
    numberRepeatFindings: 0,
    numberRepeatResults: 0,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 132,
    numberUnassignedVulnerabilities: 0,
    scannerName: "Trivy",
    updatedDate: 1634655999000,
  },
  {
    buildId: null,
    id: 3825,
    importTime: 1634293054000,
    numberClosedVulnerabilities: 0,
    numberCriticalVulnerabilities: 19,
    numberHighVulnerabilities: 73,
    numberInfoVulnerabilities: 0,
    numberLowVulnerabilities: 615,
    numberMediumVulnerabilities: 176,
    numberNewVulnerabilities: 883,
    numberOldVulnerabilities: 1766,
    numberRepeatFindings: 0,
    numberRepeatResults: 0,
    numberResurfacedVulnerabilities: 0,
    numberTotalVulnerabilities: 883,
    numberUnassignedVulnerabilities: 0,
    scannerName: "Trivy",
    updatedDate: 1634293054000,
  },
];

describe("#isInCalendarWeek()", function () {
  it("should return true if a given timestamp is inside the given calendar week and year", function () {
    // Timestamps from threadfix are X1000
    // fn "unix() from moment NOT"
    let ts = moment("2023-01-01 18:06:03").unix() * 1000;
    let calendarWeek = 1;

    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    ts = moment("2023-01-02 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    ts = moment("2023-01-07 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    ts = moment("2022-01-07 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), false);

    ts = moment("2023-01-07 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2022), false);

    calendarWeek = 2;
    ts = moment("2023-01-08 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    calendarWeek = 51;
    ts = moment("2023-12-22 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    calendarWeek = 52;
    ts = moment("2023-12-24 18:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);

    // See comment above the function ;)
    calendarWeek = 1;
    ts = moment("2023-12-31 11:06:03").unix() * 1000;
    assert.equal(isInCalendarWeek(ts, calendarWeek, 2023), true);
  });
});

describe("#getScansOfCalendarWeek()", function () {
  it("should return only the scans which are in a given calendar week and year", function () {
    const scans = [
      {
        importTime: moment("2023-01-03 18:06:03").unix() * 1000,
      },
      {
        importTime: moment("2023-01-04 18:06:03").unix() * 1000,
      },
      {
        importTime: moment("2022-01-04 18:06:03").unix() * 1000,
      },
    ];

    const scansFound = getScansOfCalendarWeek(scans, 1, 2023);

    assert.equal(scansFound.length, 2);
  });
});

describe("#normalizeScansForHistoricalView()", function () {

  it("should normalize the scans of an app in order to provide historical views", function () {
    let scans = [
      // ============== CW1 2023
      {
        importTime: moment("2023-01-03 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 10,
        scannerName: "Trivy"
      },
      {
        importTime: moment("2023-01-03 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 8,
        scannerName: "Kiuwan"
      },
      {
        importTime: moment("2023-01-04 20:06:03").unix() * 1000,
        numberTotalVulnerabilities: 10,
        scannerName: "Kiuwan"
      },
      {
        importTime: moment("2023-01-03 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 10,
        scannerName: "KiuwanLibraries"
      },
      // ============== CW2 2023
      {
        importTime: moment("2023-01-08 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 4,
        scannerName: "Trivy"
      },
      // ============== CW3 2023
      {
        importTime: moment("2023-01-15 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 11,
        scannerName: "Trivy"
      },
      {
        importTime: moment("2023-01-15 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 2,
        scannerName: "Kiuwan"
      },
      // ============== CW4 2023
      {
        importTime: moment("2023-01-23 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 0,
        scannerName: "Trivy"
      },
      {
        importTime: moment("2023-01-23 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 0,
        scannerName: "Kiuwan"
      },
      {
        importTime: moment("2023-01-23 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 0,
        scannerName: "KiuwanLibraries"
      },
      // ============== CW5 2023
      {
        importTime: moment("2023-01-30 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 2,
        scannerName: "Trivy"
      },
      {
        importTime: moment("2023-01-30 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 2,
        scannerName: "Kiuwan"
      },
      {
        importTime: moment("2023-01-30 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 2,
        scannerName: "KiuwanLibraries"
      },

      // ============== CW6 2023 - NO SCANS. should keep data from week 5

      // ============== CW7 2023
      {
        importTime: moment("2023-02-13 18:06:03").unix() * 1000,
        numberTotalVulnerabilities: 5,
        scannerName: "Trivy"
      },
    ];

    const start_date = "2022-12-01"
    const end_date = "2023-06-01"

    const scansFilteredByWeeks = normalizeScansForHistoricalView(scans, start_date, end_date);
    // console.log("RESULT", JSON.stringify(scansFilteredByWeeks, null, 2));

    assert.deepEqual(scansFilteredByWeeks["CW49 2022"], { scans: [], total: 0, sast: 0, container: 0 });
    assert.deepEqual(scansFilteredByWeeks["CW50 2022"], { scans: [], total: 0, sast: 0, container: 0 });
    assert.deepEqual(scansFilteredByWeeks["CW51 2022"], { scans: [], total: 0, sast: 0, container: 0 });
    assert.deepEqual(scansFilteredByWeeks["CW52 2022"], { scans: [], total: 0, sast: 0, container: 0 });
    assert.deepEqual(scansFilteredByWeeks["CW53 2022"], { scans: [], total: 0, sast: 0, container: 0 });

    // CW1 2023
    assert.equal(scansFilteredByWeeks["CW1 2023"].total, 30);
    assert.equal(scansFilteredByWeeks["CW1 2023"].container, 10);
    assert.equal(scansFilteredByWeeks["CW1 2023"].sast, 20); // sast means "sast&sca"

    // CW2 2023
    assert.equal(scansFilteredByWeeks["CW2 2023"].total, 24);
    assert.equal(scansFilteredByWeeks["CW2 2023"].container, 4);
    assert.equal(scansFilteredByWeeks["CW2 2023"].sast, 20); // still 20 from last week!

    // CW3 2023
    assert.equal(scansFilteredByWeeks["CW3 2023"].total, 23);
    assert.equal(scansFilteredByWeeks["CW3 2023"].container, 11);
    assert.equal(scansFilteredByWeeks["CW3 2023"].sast, 12);

    // CW4 2023
    assert.equal(scansFilteredByWeeks["CW4 2023"].total, 0);
    assert.equal(scansFilteredByWeeks["CW4 2023"].container, 0);
    assert.equal(scansFilteredByWeeks["CW4 2023"].sast, 0);

    // CW5 2023
    assert.equal(scansFilteredByWeeks["CW5 2023"].total, 6);
    assert.equal(scansFilteredByWeeks["CW5 2023"].container, 2);
    assert.equal(scansFilteredByWeeks["CW5 2023"].sast, 4);

    // CW6 2023 - keep from 5!
    assert.equal(scansFilteredByWeeks["CW6 2023"].total, 6);
    assert.equal(scansFilteredByWeeks["CW6 2023"].container, 2);
    assert.equal(scansFilteredByWeeks["CW6 2023"].sast, 4);

    // CW7 2023
    assert.equal(scansFilteredByWeeks["CW7 2023"].total, 9);
    assert.equal(scansFilteredByWeeks["CW7 2023"].container, 5);
    assert.equal(scansFilteredByWeeks["CW7 2023"].sast, 4);

    // CW8 2023 - no new scans, still same
    assert.equal(scansFilteredByWeeks["CW8 2023"].total, 9);
    assert.equal(scansFilteredByWeeks["CW8 2023"].container, 5);
    assert.equal(scansFilteredByWeeks["CW8 2023"].sast, 4);

    // CW23 2023
    assert.equal(scansFilteredByWeeks["CW23 2023"].total, 9);
    assert.equal(scansFilteredByWeeks["CW23 2023"].container, 5);
    assert.equal(scansFilteredByWeeks["CW23 2023"].sast, 4);
  });
});
