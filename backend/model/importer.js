/**
 * This script runs in a cron every night and imports data from defect dojo to our mongo db.
 */
import App from "./App.js";
import connection from "./connection.js";
import { fetchDataFromDefectDojo } from "../adapters/defect_dojo.js";
import moment from "moment";

// ignore tls cert verification (self signed cert)
process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";

connection.then(async () => {
  const start = moment()
  console.log("START IMPORT", start)

  // in order to make it simple (prevent complicated update logic),
  // just drop ALL and import ALL again, why not ?
  await App.deleteMany({});
  const a = await App.find({});
  console.log("DELETED ALL APPS IN OUR DB", a);

  const apps = await fetchDataFromDefectDojo();

  for (const appFetched of apps) {
    const app = new App(appFetched);

    try {
      await app.save();
      console.log("saved app! " + app.name);
    }
    catch (e) {
      console.log("ERROR saving app", e)
    }
  }

  const duration = moment.duration(moment().diff(start));

  console.log("DONE IMPORTING. Time: ", duration.asMinutes(), " minutes");
  process.exit(0)
});
