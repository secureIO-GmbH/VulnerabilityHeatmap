import express from "express";
// const fs = require('fs');
import { normalize } from "./adapters/threadfix.js";
import {
  // fetchKiuwanApps,
  fetchDataFromKiuwan,
} from "./adapters/kiuwan.js";

import fs from "fs";
import axios from "axios";
import https from "https";
import http from "http";
import { THREADFIX_APIKEY, THREADFIX_BASEURL } from "./config.js";
//import data from "./adapters/threadfix_response.json" assert { type: "json" };
import path from "path";
import App from "./model/App.js";
import connection from "./model/connection.js";

const env = process.env.NODE_ENV;

const agent = new https.Agent({
  rejectUnauthorized: false,
});
axios.defaults.httpsAgent = agent;

const __dirname = path.resolve(path.dirname(""));
const app = express();
const port = process.env.PORT || 9876;

let httpsPort, credentials;

if (env === "production") {
  httpsPort = process.env.HTTPS_PORT || 9443;

  // Load certificate and private key for HTTPS
  const privateKey = fs.readFileSync(
    "./backend/certs/mucsgappsec01.key",
    "utf8"
  );
  const certificate = fs.readFileSync(
    "./backend/certs/mucsgappsec01.crt",
    "utf8"
  );
  credentials = { key: privateKey, cert: certificate };

  // Middleware to redirect HTTP to HTTPS
  app.use((req, res, next) => {
    if (req.secure) {
      // Request is already secure, continue to the next middleware or route
      return next();
    }
    // Redirect HTTP to HTTPS with the correct port
    const host = req.headers.host.split(":")[0]; // Extract hostname without port
    res.redirect(`https://${host}:${httpsPort}${req.url}`);
  });
}

app.use("/", express.static(__dirname + "/"));

// const axiosConfig = {
//   mode: "no-cors",
//   rejectUnauthorized: false,
//   headers: {
//     Authorization: "APIKEY " + THREADFIX_APIKEY,
//   },
// };

/**
 * Defect Dojo API
 */
app.get("/api/dd", async function (req, res) {
  console.log("fetching data..");
  let apps;

  // TODO: not sure, do it on the FE
  if (req.query.name) {
    apps = await App.find().where("name").in(req.query.name);
  } else {
    apps = await App.find();
  }

  res.writeHead(200, { "Content-Type": "application/json" });
  res.end(apps ? JSON.stringify(apps) : "[]");
});

if (env === "production") {
  // Create the HTTPS server
  const httpsServer = https.createServer(credentials, app);

  // Listen on the specified port for HTTPS
  httpsServer.listen(httpsPort, () => {
    console.log(`HTTPS Server listening on port ${httpsPort}`);
  });
}

// Create an HTTP server that uses the same Express app
const httpServer = http.createServer(app);

httpServer.listen(port, () => {
  console.log(`HTTP Server listening on port ${port}`);
});
